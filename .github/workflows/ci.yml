name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write  # Needed to create tags and releases
  packages: write  # Needed if publishing packages
  actions: read    # Needed to read workflow artifacts

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: '1'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: '1'
  VERSION_MAJOR: '1'
  VERSION_MINOR: '0'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 'ğŸ”„ Checkout'
        uses: actions/checkout@v5
        with:
          fetch-tags: true # https://github.com/actions/checkout/issues/1471#issuecomment-1771231294
          fetch-depth: 0

      - name: 'ğŸ”§ Setup .NET'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'

      # ============================ VERSION ============================
      - name: 'ğŸ” Calculate version'
        id: version
        shell: 'bash'
        run: |
          echo "ğŸ” Calculating next version for ${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}.x"

          PATTERN="v${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}.*"
          echo "ğŸ“‹ Looking for existing tags matching pattern: $PATTERN"

          # List all matching tags for debugging
          echo "ğŸ” All tags matching pattern:"
          git tag -l "$PATTERN" || echo "No tags found"

          TAGS=$(git tag -l "v${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}.*")
          if [ -z "$TAGS" ]; then
            echo "â„¹ï¸  No existing tags found for ${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}.x, starting with patch 0"
            NEXT_PATCH=0
          else
            LATEST_PATCH=$(echo "$TAGS" | grep -E "^v${{ env.VERSION_MAJOR }}\.${{ env.VERSION_MINOR }}\.[0-9]+$" | sed "s/^v${{ env.VERSION_MAJOR }}\.${{ env.VERSION_MINOR }}\.//" | sort -n | tail -1)
            if [ -z "$LATEST_PATCH" ]; then
              NEXT_PATCH=0
            else
              NEXT_PATCH=$((LATEST_PATCH + 1))
            fi
          fi
          FULL_VERSION="${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}.$NEXT_PATCH"

          echo "ğŸ¯ Next version will be: v$FULL_VERSION"

          # Set outputs
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "MAJOR=${{ env.VERSION_MAJOR }}" >> $GITHUB_OUTPUT
          echo "MINOR=${{ env.VERSION_MINOR }}" >> $GITHUB_OUTPUT
          echo "PATCH=$NEXT_PATCH" >> $GITHUB_OUTPUT

          # Also set as environment variables for subsequent steps
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV

      # ============================ BUILD ============================
      - name: 'ğŸ”„ Restore'
        run: dotnet restore Plugin.ByteArrays.slnx

      - name: 'ğŸ”¨ Build'
        run: >
          dotnet build Plugin.ByteArrays.slnx
          -c Release
          --no-restore
          -p:Version_Full=${{ steps.version.outputs.FULL_VERSION }}
          -p:Version_Assembly=${{ steps.version.outputs.FULL_VERSION }}
          -p:GeneratePackageOnBuild=true
          -p:PackageOutputPath=${{ github.workspace }}/output/packages

      - name: 'ğŸ“¦ Upload NuGet packages'
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: ${{ github.workspace }}/output/packages
          if-no-files-found: error

      # ============================ TESTS & COVERAGE ============================
      - name: 'ğŸ§ª Test with coverage (95% min)'
        shell: bash
        run: >
          dotnet test Plugin.ByteArrays.Tests/Plugin.ByteArrays.Tests.csproj
          -c Release
          --no-build
          --logger "trx;LogFileName=test-results.trx"
          -p:TestOutputPath="${{ github.workspace }}/output/tests"
          -p:CollectCoverage=true
          -p:CoverletOutputFormat=cobertura
          '-p:Exclude="[xunit.*]*,[FluentAssertions.*]*,[Plugin.ByteArrays.Tests]*"'

      - name: 'ğŸ“¦ Upload test artifacts'
        uses: actions/upload-artifact@v4
        with:
          name: tests
          path: |
            ${{ github.workspace }}/output/tests/tests.cobertura.xml
            ${{ github.workspace }}/output/tests/test-results.trx

      - name: Code Coverage Summary Report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: ${{ github.workspace }}/output/tests/tests.cobertura.xml
          format: markdown
          badge: true
          fail_below_min: true
          indicators: true
          output: both
          thresholds: '60 80'

      - name: 'ğŸ“¦ Move Coverage Report'
        shell: bash
        run: |
          mv ${{ github.workspace }}/code-coverage-results.md ${{ github.workspace }}/Plugin.ByteArrays.Docs/coverage.md

      # ============================ DOCS ============================
      - name: 'ğŸ“š Install DocFX'
        shell: bash
        run: |
          if [ ! -f .config/dotnet-tools.json ]; then
            echo "ğŸ“ Creating tool manifest..."
            dotnet new tool-manifest
          fi
          dotnet tool install docfx

      - name: 'ğŸ“š Generate Documentation'
        shell: bash
        run: |
          echo "ğŸ“š Generating documentation..."
          dotnet docfx metadata Plugin.ByteArrays.Docs/docfx.json --output ${{ github.workspace }}/output/docs/api
          dotnet docfx build Plugin.ByteArrays.Docs/docfx.json --output ${{ github.workspace }}/output/docs/site

      - name: "ğŸ“¦ Upload GitHub Pages artifact"
        uses: actions/upload-pages-artifact@v4
        with:
          path: ${{ github.workspace }}/output/docs/site

      - name: "ğŸš€ Deploy to GitHub Pages"
        id: deployment
        uses: actions/deploy-pages@v4

      # ============================ TAGGING ============================
      - name: 'ğŸ·ï¸ Create tag'
        shell: bash
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
            echo "ğŸ·ï¸  Creating tag v${{ steps.version.outputs.FULL_VERSION }}"

            git config --local user.email "${{ github.actor }}@users.noreply.github.com"
            git config --local user.name "${{ github.actor }}"

            if [ $(git tag -l "v${{ steps.version.outputs.FULL_VERSION }}") ]; then
                echo "âš ï¸  Tag v${{ steps.version.outputs.FULL_VERSION }} already exists"
                exit 1
            else
                echo "âœ… Creating new tag v${{ steps.version.outputs.FULL_VERSION }}"
                git tag -a "v${{ steps.version.outputs.FULL_VERSION }}" -m "Release v${{ steps.version.outputs.FULL_VERSION }}"
                git push origin "v${{ steps.version.outputs.FULL_VERSION }}"
                echo "ğŸš€ Tag v${{ steps.version.outputs.FULL_VERSION }} created and pushed"
            fi

      - name: 'ğŸ“€ Create Release'
        shell: bash
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
            echo "ğŸ“€ Creating GitHub release for v${{ steps.version.outputs.FULL_VERSION }}"

            gh auth login --with-token <<< "${{ github.token }}"

            # Check if release already exists
            if gh release view "v${{ steps.version.outputs.FULL_VERSION }}" --repo ${{ github.repository }} >/dev/null 2>&1; then
                echo "âš ï¸  Release v${{ steps.version.outputs.FULL_VERSION }} already exists"
            else
                echo "âœ… Creating new release v${{ steps.version.outputs.FULL_VERSION }}"
                gh release create "v${{ steps.version.outputs.FULL_VERSION }}" \
                --title "Release v${{ steps.version.outputs.FULL_VERSION }}" \
                --generate-notes \
                --target "${{ github.sha }}" \
                --repo ${{ github.repository }}
                echo "ğŸš€ Release v${{ steps.version.outputs.FULL_VERSION }} created successfully"
            fi
